generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["fullTextSearch", "typedSql"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Source {
  GITHUB
  DOTORG
  CUSTOM
  UNKNOWN
}

model Plugin {
  id                     String               @id @unique @default(uuid())
  source                 Source               @default(UNKNOWN)
  slug                   String
  name                   String?
  author                 Author?              @relation(fields: [authorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  authorId               String?
  authorProfile          String?
  tested                 String?
  requirements           PluginRequirements?
  homepage               String?
  description            PluginDescription?
  tags                   Tag[]
  donateLink             String?
  version                String?
  versions               PluginVersion[]
  icons                  PluginIcon[]
  banners                PluginBanner[]
  screenshots            PluginScreenshot[]
  dotOrgStats            DotOrgPluginStats?

  @@unique([source, slug])
}

model PluginRequirements {
  id          String   @id @unique @default(uuid())
  pluginId    String   @unique
  plugin      Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  pluginSlugs String[]
  phpVersion  String?
  wpVersion   String?
}

model PluginDescription {
  id          String   @id @unique @default(uuid())
  pluginId    String   @unique
  plugin      Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  full        String?
  short       String?
}

model DotOrgPluginStats {
  id                     String    @id @unique
  plugin                 Plugin    @relation(fields: [id], references: [id], onDelete: Cascade, onUpdate: Cascade)
  added                  DateTime? @default(now())
  updated                DateTime?
  activeInstalls         Int?
  downloads              Int?
  rating                 Int?
  ratingCount            Int?
  ratingStars1           Int?
  ratingStars2           Int?
  ratingStars3           Int?
  ratingStars4           Int?
  ratingStars5           Int?
  supportThreads         Int?
  supportThreadsResolved Int?
}

model Author {
  id               String    @id @unique @default(uuid())
  name             String
  plugins          Plugin[]
  dotOrgProfileUrl String?  @unique
}

model Tag {
  slug    String   @id @unique
  name    String
  plugins Plugin[]
}

model PluginVersion {
  id              String         @id @unique @default(uuid())
  version         String
  pluginId        String
  plugin          Plugin         @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  downloadLinkIds String[]       @unique
  downloadLinks   DownloadLink[]
  added           DateTime?      @default(now())
  updatedAt       DateTime       @updatedAt @default(now())

  @@unique([pluginId, version])
}

model DownloadLink {
  id              String         @id @unique
  source          Source         @default(UNKNOWN)
  url             String         @unique
  fileId          Int?           @unique
  fileInfo        FileInfo?
  pluginVersionId String?
  pluginVersion   PluginVersion? @relation(fields: [pluginVersionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model FileInfo {
  id        String        @id @unique @default(uuid())
  name      String?
  size      Int?
  md5       String?
  sha1      String?
  sha256    String?
  sha512    String?
  mime      String?
  ext       String?
  path      String?
  updatedAt DateTime      @updatedAt @default(now())
  linkId    String?       @unique
  sourceUrl DownloadLink? @relation(fields: [linkId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model PluginIcon {
  id       String  @id @unique @default(uuid())
  pluginId String
  plugin   Plugin  @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  source   Source  @default(UNKNOWN)
  slug     String
  url      String
}

model PluginBanner {
  id       String  @id @unique @default(uuid())
  pluginId String
  plugin   Plugin  @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  source   Source  @default(UNKNOWN)
  slug     String
  url      String
}

model PluginScreenshot {
  id       String  @id @unique @default(uuid())
  pluginId String
  plugin   Plugin  @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  source   Source  @default(UNKNOWN)
  url      String
  caption  String?
  slug     String
}
