generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Source {
  GITHUB
  DOTORG
  CUSTOM
  UNKNOWN
}

model Plugin {
  id                     Int                 @id @default(autoincrement())
  source                 Source              @default(UNKNOWN)
  slug                   String              
  name                   String?
  author                 Author?              @relation(fields: [authorId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  authorId               Int?
  authorProfile          String?
  tested                 String?
  requirements           PluginRequirements?
  homepage               String?
  description            PluginDescription?
  tags                   Tag[]
  donateLink             String?
  version                String?       
  versions               PluginVersion[]
  icons                  PluginIcon[]
  banners                PluginBanner[]
  screenshots            PluginScreenshot[]
  dotOrgStats            DotOrgPluginStats?

  @@unique([source, slug])
}

model PluginRequirements {
  id          Int      @id @default(autoincrement())
  pluginId    Int      @unique
  plugin      Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  pluginSlugs String[]
  phpVersion  String?
  wpVersion   String?
}

model PluginDescription {
  id          Int      @id @default(autoincrement())
  pluginId    Int      @unique
  plugin      Plugin   @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  full        String?
  short       String?
}

model DotOrgPluginStats {
  id                     Int       @id @default(autoincrement())
  pluginId               Int       @unique
  plugin                 Plugin    @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  added                  DateTime? @default(now())
  updated                DateTime?
  activeInstalls         Int?
  downloads              Int?
  rating                 Int?
  ratingCount            Int?
  ratingStars1           Int?
  ratingStars2           Int?
  ratingStars3           Int?
  ratingStars4           Int?
  ratingStars5           Int?
  supportThreads         Int?
  supportThreadsResolved Int?
}

model Author {
  id               Int      @id @default(autoincrement())
  name             String
  plugins          Plugin[]
  dotOrgProfileUrl String?  @unique
}

model Tag {
  slug    String   @id @unique
  name    String
  plugins Plugin[]
}

model PluginVersion {
  id              Int            @id @default(autoincrement())
  version         String
  pluginId        Int
  plugin          Plugin         @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  downloadLinkIds Int[]          @unique
  downloadLinks   DownloadLink[]
  added           DateTime?      @default(now())
  updatedAt       DateTime       @updatedAt @default(now())

  @@unique([pluginId, version])
}

model DownloadLink {
  id              Int           @id @default(autoincrement())
  source          Source        @default(UNKNOWN)
  url             String        @unique
  fileId          Int?          @unique
  fileInfo        FileInfo?     @relation(fields: [fileId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  pluginVersionId Int?
  pluginVersion   PluginVersion? @relation(fields: [pluginVersionId], references: [id], onDelete: Cascade, onUpdate: Cascade)
}

model FileInfo {
  id        Int    @id @default(autoincrement())
  sourceUrl DownloadLink?
  name      String?
  size      Int?
  md5       String?
  sha1      String?
  sha256    String?
  sha512    String?
  mime      String?
  ext       String?
  path      String?
  updatedAt DateTime @updatedAt
}

model PluginIcon {
  id       Int    @id @default(autoincrement())
  pluginId Int    
  plugin   Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  source   Source @default(UNKNOWN)
  slug     String
  url      String
}

model PluginBanner {
  id       Int    @id @default(autoincrement())
  pluginId Int    
  plugin   Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  source   Source @default(UNKNOWN)
  slug     String
  url      String
}

model PluginScreenshot {
  id       Int    @id @default(autoincrement())
  pluginId Int    
  plugin   Plugin @relation(fields: [pluginId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  source   Source @default(UNKNOWN)
  url      String
  caption  String?
  slug     String
}
